---
title: "Clustering presequences"
author: "Katarzyna Sidorczuk"
date: "24/01/2022"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 14, fig.height = 10, warning = FALSE, message = FALSE, cache = TRUE)

library(dplyr)
library(biogram)
library(seqR)
library(ggbiplot)
library(ggrepel)
library(cluster)
library(factoextra)
library(tsne)
library(umap)
library(DT)
library(tidyr)
library(ggplot2)
library(ggdendro)
library(grid)
library(gridExtra)
library(targets)
library(plotly)
library(scales)

set.seed(73607254)

my_DT <- function(x, ...)
  datatable(x, ..., escape = FALSE, extensions = 'Buttons', filter = "top", rownames = FALSE,
            style = "bootstrap")

options(DT.options = list(dom = "Brtip",
                          buttons = c("copy", "csv", "excel", "print"),
                          pageLength = 50
))

add_group <- function(df) {
  mutate(df,
         group = case_when(dataset %in% c("Amyloids combined", "AmyPro regions", "CPAD peptides") ~ "Amyloids",
                           dataset %in% c("cTP experimentally verified location", "cTP experimentally verified presequence") ~ "cTP",
                           dataset %in% c("cTP-mTP experimentally verified location", "cTP-mTP experimentally verified presequence") ~ "cTP-mTP",
                           dataset %in% c("mTP experimentally verified location", "mTP experimentally verified presequence") ~ "mTP",
                           dataset == "SP experimentally verified presequence" ~ "SP",
                           dataset %in% c("DBAASP AMP", "DBAASP AMP max 100 aa") ~ "AMP",
                           dataset %in% c("TM regions experimentally verified - alpha", "TM regions experimentally verified - beta") ~ "Transmembrane")) 
}

source("functions/extract_features.R")
source("functions/aa_comp_functions.R")

colors <- c("AmyPro regions" = "#e44496", "CPAD peptides" = "#8d44e4", 
            "cTP experimentally verified location" = "#528313", "cTP-mTP experimentally verified location" = "#837713", 
            "cTP-mTP experimentally verified presequence" ="#e4d345", "cTP experimentally verified presequence" = "#9de444", 
            "DBAASP AMP" = "#831313", "DBAASP AMP max 100 aa" = "#e44444", "mTP experimentally verified location" = "#834813", 
            "mTP experimentally verified presequence" = "#e49144", "SP experimentally verified presequence" = "#45e495", 
            "TM regions experimentally verified - alpha" = "#44aee4", "TM regions experimentally verified - beta" = "#4451e4")

colors_short <- c("Amyloids" = "#bb45e4", "cTP-mTP" ="#e4d345", "cTP" = "#9de444", 
                  "AMP" = "#831313", "mTP" = "#e49144", "SP" = "#45e495", 
                  "TM alpha" = "#44aee4", "TM beta" = "#4451e4")

prop_list <- c("BIGC670101", "CHAM820101", "CHOP780201", "CHOP780202", "CHOP780203",
               "FAUJ880103", "KLEP840101", "KYTJ820101", "ZIMJ680103")

tar_load(c(datasets_list, datasets_list_cdhit))

datasets_list_reduced <- list("Amyloids" = datasets_list_cdhit[["Amyloids combined"]],
                              "cTP-mTP" = c(datasets_list_cdhit[["cTP-mTP experimentally verified location"]], datasets_list_cdhit[["cTP-mTP experimentally verified presequence"]])[which(!duplicated( c(datasets_list_cdhit[["cTP-mTP experimentally verified location"]], datasets_list_cdhit[["cTP-mTP experimentally verified presequence"]])))],
                              "cTP" = c(datasets_list_cdhit[["cTP experimentally verified location"]], datasets_list_cdhit[["cTP experimentally verified presequence"]])[which(!duplicated( c(datasets_list_cdhit[["cTP experimentally verified location"]], datasets_list_cdhit[["cTP experimentally verified presequence"]])))],
                              "mTP" = c(datasets_list_cdhit[["mTP experimentally verified location"]], datasets_list_cdhit[["mTP experimentally verified presequence"]])[which(!duplicated( c(datasets_list_cdhit[["mTP experimentally verified location"]], datasets_list_cdhit[["mTP experimentally verified presequence"]])))],
                              "SP" = datasets_list_cdhit[["SP experimentally verified presequence"]],
                              "AMP" = datasets_list_cdhit[["DBAASP AMP"]],
                              "TM alpha" = datasets_list_cdhit[["TM regions experimentally verified - alpha"]],
                              "TM beta" = datasets_list_cdhit[["TM regions experimentally verified - beta"]])

datasets_list <- datasets_list[which(names(datasets_list) != "Amyloids combined")]
datasets_list_cdhit <- datasets_list_cdhit[which(names(datasets_list_cdhit) != "Amyloids combined")]
datasets <- unlist(sapply(names(datasets_list_reduced), function(i) rep(i, length(datasets_list_reduced[[i]])), USE.NAMES = FALSE))
datasets_cdhit <- unlist(sapply(names(datasets_list_cdhit), function(i) rep(i, length(datasets_list_cdhit[[i]])), USE.NAMES = FALSE))
```

## Data exploration

### Numbers of sequences in each data set
```{r}
ds_len <- lengths(datasets_list) %>% 
  data.frame() %>% 
  setNames("Number of sequences")
ds_len_cdhit <- lengths(datasets_list_cdhit) %>% 
  data.frame() %>% 
  setNames("After CD-HIT 70%")
knitr::kable(cbind(ds_len, ds_len_cdhit))
```

### Length distribution
```{r}
len_df <- lapply(names(datasets_list), function(i) {
  data.frame(dataset = i,
             length = unname(lengths(datasets_list[[i]])))
}) %>% bind_rows()

ggplot(len_df, aes(x = dataset, y = length, fill = dataset)) +
  geom_violin() +
  facet_wrap(~dataset, scales = "free", ncol = 5) +
  scale_fill_manual("Data set", values = colors) +
  theme_bw() +
  theme(legend.position = "none", 
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank())

ggplot(len_df, aes(x = dataset, y = length, fill = dataset)) +
  geom_violin() +
  facet_wrap(~dataset, scales = "free_x", ncol = 5) +
  scale_fill_manual("Data set", values = colors) +
  theme_bw() +
  theme(legend.position = "none", 
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank())
```
```{r fig.height = 12}
ggplot(len_df, aes(x = dataset, y = length, fill = dataset)) +
  geom_violin() +
  scale_fill_manual("Data set", values = colors) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90)) + 
  coord_flip()

len_df %>% 
  group_by(dataset) %>% 
  summarise(min = min(length),
            `1st_quartile` = summary(length)[["1st Qu."]],
            mean = mean(length),
            median = median(length),
            `3rd_quartile` = summary(length)[["3rd Qu."]],
            max = max(length)) %>% 
  knitr::kable()
```

### Amino acid composition of whole datasets before CD-HIT
```{r}
aa_comp_datasets <- lapply(names(datasets_list), function(i) {
  aa <- unlist(datasets_list[[i]], use.names = FALSE)
  as.data.frame(table(aa)/length(aa)) %>% 
    mutate(dataset = i)
}) %>% bind_rows()

aa_comp_datasets %>% 
  add_group() %>% 
  ggplot(aes(x = aa, y = Freq, fill = dataset)) +
  geom_col(position = "dodge") +
  facet_wrap(~group) +
  theme_bw() +
  scale_fill_manual("Data set", values = colors) 

ggplot(aa_comp_datasets, aes(x = dataset, y = Freq, fill = dataset)) +
  geom_col() +
  facet_wrap(~aa) +
  theme_bw() +
  scale_fill_manual("Data set", values = colors) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) 

get_aa_comp_heatmap(aa_comp_datasets)
```

### Amino acid composition of whole datasets after CD-HIT
```{r}
aa_comp_datasets <- lapply(names(datasets_list_cdhit), function(i) {
  aa <- unlist(datasets_list_cdhit[[i]], use.names = FALSE)
  as.data.frame(table(aa)/length(aa)) %>% 
    mutate(dataset = i)
}) %>% bind_rows()

aa_comp_datasets %>% 
  add_group() %>% 
  ggplot(aes(x = aa, y = Freq, fill = dataset)) +
  geom_col(position = "dodge") +
  facet_wrap(~group) +
  theme_bw() +
  scale_fill_manual("Data set", values = colors) 

ggplot(aa_comp_datasets, aes(x = dataset, y = Freq, fill = dataset)) +
  geom_col() +
  facet_wrap(~aa) +
  theme_bw() +
  scale_fill_manual("Data set", values = colors) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) 

get_aa_comp_heatmap(aa_comp_datasets)
```

### Amino acid composition of peptides (after CD-HIT)
```{r}
aa_comp_peptides <- calculate_aa_comp_peptides(datasets_list_cdhit)
all_combns <- get_statistical_analysis_aa_comp(aa_comp_peptides, 
                                               combn(sort(unique(aa_comp_peptides[["dataset"]])), 2, simplify = FALSE))

ggplot(all_combns, aes(x = dataset1, y = dataset2, fill = is_signif)) +
  geom_tile(color = "white") +
  facet_wrap(~aa) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        axis.text.x = element_text(angle = 90)) +
  coord_fixed(ratio = 1) +
  scale_fill_manual("Is significant", values = c(`FALSE` = "#76bef2", `TRUE` = "#ff4242")) +
  xlab("First data set") +
  ylab("Second data set")


selected_combns <- get_statistical_analysis_aa_comp(aa_comp_peptides, list(c("AmyPro regions", "CPAD peptides"),
                                                                           c("cTP experimentally verified location", "cTP experimentally verified presequence"), 
                                                                           c("cTP experimentally verified location", "cTP-mTP experimentally verified location"), 
                                                                           c("cTP experimentally verified location", "cTP-mTP experimentally verified presequence"),
                                                                           c("cTP experimentally verified presequence", "cTP-mTP experimentally verified location"), 
                                                                           c("cTP experimentally verified presequence", "cTP-mTP experimentally verified presequence"),
                                                                           c("cTP-mTP experimentally verified location", "cTP-mTP experimentally verified presequence"),
                                                                           c("cTP-mTP experimentally verified location", "mTP experimentally verified presequence"),
                                                                           c("cTP-mTP experimentally verified presequence", "mTP experimentally verified presequence"),
                                                                           c("cTP-mTP experimentally verified location", "mTP experimentally verified location"),
                                                                           c("cTP-mTP experimentally verified presequence", "mTP experimentally verified location"),
                                                                           c("mTP experimentally verified location", "mTP experimentally verified presequence"), 
                                                                           c("DBAASP AMP", "DBAASP AMP max 100 aa")))
```
```{r fig.height = 8}
selected_combns %>% 
  mutate(comparison = paste0(dataset1, " vs. ", dataset2)) %>% 
  ggplot(aes(x = aa, y = comparison, fill = is_signif)) +
  geom_tile(color = "white") +
  coord_fixed(ratio = 1) +
  theme_bw() +
  theme(panel.grid.major = element_blank()) +
  scale_fill_manual("Is significant", values = c(`FALSE` = "#76bef2", `TRUE` = "#ff4242")) 

```

### PCA on amino acid composition (after CD-HIT)
```{r}
pca_data_all <- aa_comp_datasets %>% 
  pivot_wider(names_from = aa, values_from = Freq, values_fill = 0) 

pca_res_all <- prcomp(pca_data_all[, 2:ncol(pca_data_all)], center = TRUE, scale = TRUE)

ggbiplot(pca_res_all, choices = 1:2) +
  theme_bw() +
  geom_point(aes(color = pca_data_all[["dataset"]]), size = 3) +
  geom_text_repel(label = pca_data_all[["dataset"]]) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual("Data set", values = colors) +
  theme(legend.position = "none")
```

### PCA on physicochemical properties (after CD-HIT)
```{r}
props <- lapply(seq_along(datasets_list_cdhit), function(i) {
  as.data.frame(calculate_properties(datasets_list_cdhit[[i]], prop_list))
}) %>% do.call(rbind, .)

pca_res_props_all <- prcomp(props, center = TRUE, scale = TRUE)

ggbiplot(pca_res_props_all, choices = 1:2, alpha = 0.25, ellipse = TRUE, groups = datasets_cdhit) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual("Data set", values = colors)

pca_res_props_all[["x"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_cdhit) %>%
  add_group() %>%
  ggplot(aes(x = PC1, y = PC2, color = dataset)) +
  geom_point(alpha = 0.5) +
  scale_color_manual("Data set", values = colors) +
  facet_wrap(~group) +
  theme_bw()
```

## Clustering of grouped datasets

Numbers of sequences
```{r}
lengths(datasets_list_reduced) %>% 
  data.frame() %>% 
  setNames("After CD-HIT 70% (combined)") %>% 
  knitr::kable()
```

### Amino acid composition of peptides

```{r}
aa_comp_peptides1 <- calculate_aa_comp_peptides(datasets_list_reduced)

aa_comp_peptides1_clust_data <- aa_comp_peptides1 %>%
  pivot_wider(names_from = `Amino acid`, values_from = `Frequency`) %>%
  select(-c(dataset, prot))
```

#### PCA
```{r}
pca_aa_res1 <- prcomp(aa_comp_peptides1_clust_data, center = TRUE, scale = TRUE)

ggbiplot(pca_aa_res1, choices = 1:2, alpha = 0.25, ellipse = TRUE, groups = datasets) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual("Data set", values = colors_short)

ggbiplot(pca_aa_res1, choices = 1:2, alpha = 0.25, ellipse = TRUE, groups = datasets) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none") +
  scale_color_manual("Data set", values = colors_short) +
  facet_wrap(~groups, ncol = 5)
```

#### t-SNE

Perplexity = 30
```{r}
tsne_aa_res1 <- tsne(aa_comp_peptides1_clust_data, k = 2, perplexity = 30, max_iter = 1000)
mutate(as.data.frame(tsne_aa_res1), dataset = datasets) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point(size = 2) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

#### UMAP

Neighbors = 30, spread = 2, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 2
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 30

umap_res1 <- umap(aa_comp_peptides1_clust_data, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

Neighbors = 50, spread = 2, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 2
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 50

umap_res1 <- umap(aa_comp_peptides1_clust_data, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```


### Physicochemical properties

```{r}
props <- lapply(seq_along(datasets_list_reduced), function(i) {
  as.data.frame(calculate_properties(datasets_list_reduced[[i]], prop_list))
}) %>% do.call(rbind, .)
```

#### PCA
```{r}
pca_props_res1 <- prcomp(props, center = TRUE, scale = TRUE)

ggbiplot(pca_props_res1, choices = 1:2, alpha = 0.25, ellipse = TRUE, groups = datasets) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual("Data set", values = colors_short)

ggbiplot(pca_props_res1, choices = 1:2, alpha = 0.25, ellipse = TRUE, groups = datasets) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none") +
  scale_color_manual("Data set", values = colors_short) +
  facet_wrap(~groups, ncol = 5)
```

#### t-SNE

Perplexity = 30
```{r}
tsne_props_res1 <- tsne(props, k = 2, perplexity = 30, max_iter = 1000)
mutate(as.data.frame(tsne_props_res1), dataset = datasets) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point(size = 2) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

#### UMAP

Neighbors = 30, spread = 1, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 1
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 30

umap_res1 <- umap(props, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

Neighbors = 50, spread = 1, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 1
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 50

umap_res1 <- umap(props, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```


### Bigrams

```{r}
bigrams <- lapply(names(datasets_list_reduced), function(i) {
  calculate_binary_ngram_matrix(datasets_list_reduced[[i]],
                                c(2, 2),
                                list(NULL, 1))
}) %>% bind_rows()
bigrams[is.na(bigrams)] <- 0
```

#### PCA
```{r}
pca_bigram_res1 <- prcomp(bigrams, center = TRUE, scale = TRUE)

ggbiplot(pca_bigram_res1, choices = 1:2, groups = datasets, var.axes = FALSE) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual("Data set", values = colors_short) +
  theme(legend.position = "none")

pca_bigram_res1[["x"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets) %>%
  ggplot(aes(x = PC1, y = PC2, color = dataset)) +
  geom_point(alpha = 0.5) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
pca_bigram_res1[["x"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets) %>%
  ggplot(aes(x = PC1, y = PC2, color = dataset)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~dataset) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw() +
  theme(legend.position = "none")
```

#### t-SNE

Perplexity = 30
```{r}
tsne_bigrams_res1 <- tsne(bigrams, k = 2, perplexity = 30, max_iter = 1000)
mutate(as.data.frame(tsne_bigrams_res1), dataset = datasets) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point(size = 2) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

#### UMAP

Neighbors = 30, spread = 1, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 1
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 30

umap_res1 <- umap(bigrams, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

Neighbors = 50, spread = 1, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 1
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 50

umap_res1 <- umap(bigrams, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

### Trigrams

```{r}
trigrams <- lapply(names(datasets_list_reduced), function(i) {
  calculate_binary_ngram_matrix(datasets_list_reduced[[i]],
                                c(3, 3, 3, 3),
                                list(c(0, 0), c(1, 0), c(0, 1), c(1, 1)))
}) %>% bind_rows()
trigrams[is.na(trigrams)] <- 0
```

### PCA
```{r}
pca_trigram_res1 <- prcomp(trigrams[vapply(trigrams, function(x) length(unique(x)) > 1, logical(1L))],
                           center = TRUE, scale = TRUE)

ggbiplot(pca_trigram_res1, choices = 1:2, groups = datasets, var.axes = FALSE) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual("Data set", values = colors_short) +
  theme(legend.position = "none")

pca_trigram_res1[["x"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets) %>%
  ggplot(aes(x = PC1, y = PC2, color = dataset)) +
  geom_point(alpha = 0.5) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()

pca_trigram_res1[["x"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets,
         name = unlist(sapply(names(datasets_list_reduced), function(i) names(datasets_list_reduced[[i]]), USE.NAMES = FALSE))) %>%
  plot_ly(x = ~PC1, y = ~PC2, color = ~dataset, colors = colors_short, text = ~name, hoverinfo = "text")

pca_trigram_res1[["x"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets) %>%
  ggplot(aes(x = PC1, y = PC2, color = dataset)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~dataset) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw() +
  theme(legend.position = "none")
```

### t-SNE

Perplexity = 30
```{r}
tsne_trigrams_res1 <- tsne(trigrams, k = 2, perplexity = 30, max_iter = 1000)
mutate(as.data.frame(tsne_trigrams_res1), dataset = datasets) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point(size = 2) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

### UMAP

Neighbors = 30, spread = 1, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 1
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 30

umap_res1 <- umap(trigrams, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

Neighbors = 50, spread = 1, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 1
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 50

umap_res1 <- umap(trigrams, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

## Clustering of experimental datasets

```{r}
datasets_list_exp <- list("Amyloids" = datasets_list_cdhit[["Amyloids combined"]],
                          "cTP-mTP" = datasets_list_cdhit[["cTP-mTP experimentally verified presequence"]],
                          "cTP" = datasets_list_cdhit[["cTP experimentally verified presequence"]],
                          "mTP" = datasets_list_cdhit[["mTP experimentally verified presequence"]],
                          "SP" = datasets_list_cdhit[["SP experimentally verified presequence"]],
                          "AMP" = datasets_list_cdhit[["DBAASP AMP"]],
                          "TM alpha" = datasets_list_cdhit[["TM regions experimentally verified - alpha"]],
                          "TM beta" = datasets_list_cdhit[["TM regions experimentally verified - beta"]])
datasets <- unlist(sapply(names(datasets_list_exp), function(i) rep(i, length(datasets_list_exp[[i]])), USE.NAMES = FALSE))
```

### Amino acid composition of peptides

```{r}
aa_comp_peptides <- calculate_aa_comp_peptides(datasets_list_exp)

aa_comp_peptides_clust_data <- aa_comp_peptides %>%
  pivot_wider(names_from = `Amino acid`, values_from = `Frequency`) %>%
  select(-c(dataset, prot))
```

#### PCA
```{r}
pca_aa_res <- prcomp(aa_comp_peptides_clust_data, center = TRUE, scale = TRUE)

ggbiplot(pca_aa_res, choices = 1:2, alpha = 0.25, ellipse = TRUE, groups = datasets_exp) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual("Data set", values = colors_short)

ggbiplot(pca_aa_res, choices = 1:2, alpha = 0.25, ellipse = TRUE, groups = datasets_exp) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none") +
  scale_color_manual("Data set", values = colors_short) +
  facet_wrap(~groups, ncol = 5)
```

#### t-SNE

Perplexity = 30
```{r}
tsne_aa_res <- tsne(aa_comp_peptides_clust_data, k = 2, perplexity = 30, max_iter = 1000)
mutate(as.data.frame(tsne_aa_res), dataset = datasets_exp) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point(size = 2) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

#### UMAP

Neighbors = 30, spread = 2, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 2
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 30

umap_res <- umap(aa_comp_peptides_clust_data, config = umap_config)
umap_res[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

Neighbors = 50, spread = 2, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 2
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 50

umap_res <- umap(aa_comp_peptides_clust_data, config = umap_config)
umap_res[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```


### Physicochemical properties

```{r}
props_exp <- lapply(seq_along(datasets_list_exp), function(i) {
  as.data.frame(calculate_properties(datasets_list_exp[[i]], prop_list))
}) %>% do.call(rbind, .)
```

#### PCA
```{r}
pca_props_res <- prcomp(props_exp, center = TRUE, scale = TRUE)

ggbiplot(pca_props_res, choices = 1:2, alpha = 0.25, ellipse = TRUE, groups = datasets_exp) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual("Data set", values = colors_short)

ggbiplot(pca_props_res, choices = 1:2, alpha = 0.25, ellipse = TRUE, groups = datasets_exp) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "none") +
  scale_color_manual("Data set", values = colors_short) +
  facet_wrap(~groups, ncol = 5)
```

#### t-SNE

Perplexity = 30
```{r}
tsne_props_res <- tsne(props_exp, k = 2, perplexity = 30, max_iter = 1000)
mutate(as.data.frame(tsne_props_res), dataset = datasets_exp) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point(size = 2) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

#### UMAP

Neighbors = 30, spread = 1, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 1
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 30

umap_res1 <- umap(props_exp, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

Neighbors = 50, spread = 1, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 1
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 50

umap_res1 <- umap(props_exp, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```


### Bigrams

```{r}
bigrams_exp <- lapply(names(datasets_list_exp), function(i) {
  calculate_binary_ngram_matrix(datasets_list_exp[[i]],
                                c(2, 2),
                                list(NULL, 1))
}) %>% bind_rows()
bigrams_exp[is.na(bigrams_exp)] <- 0
```

#### PCA
```{r}
pca_bigram_res <- prcomp(bigrams_exp, center = TRUE, scale = TRUE)

ggbiplot(pca_bigram_res, choices = 1:2, groups = datasets_exp, var.axes = FALSE) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual("Data set", values = colors_short) +
  theme(legend.position = "none")

pca_bigram_res[["x"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp) %>%
  ggplot(aes(x = PC1, y = PC2, color = dataset)) +
  geom_point(alpha = 0.5) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
pca_bigram_res[["x"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp) %>%
  ggplot(aes(x = PC1, y = PC2, color = dataset)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~dataset) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw() +
  theme(legend.position = "none")
```

#### t-SNE

Perplexity = 30
```{r}
tsne_bigrams_res <- tsne(bigrams_exp, k = 2, perplexity = 30, max_iter = 1000)
mutate(as.data.frame(tsne_bigrams_res), dataset = datasets_exp) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point(size = 2) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

#### UMAP

Neighbors = 30, spread = 1, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 1
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 30

umap_res1 <- umap(bigrams_exp, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

Neighbors = 50, spread = 1, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 1
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 50

umap_res1 <- umap(bigrams_exp, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

### Trigrams

```{r}
trigrams_exp <- lapply(names(datasets_list_exp), function(i) {
  calculate_binary_ngram_matrix(datasets_list_exp[[i]],
                                c(3, 3, 3, 3),
                                list(c(0, 0), c(1, 0), c(0, 1), c(1, 1)))
}) %>% bind_rows()
trigrams_exp[is.na(trigrams_exp)] <- 0
```

### PCA
```{r}
pca_trigram_res <- prcomp(trigrams_exp[vapply(trigrams_exp, function(x) length(unique(x)) > 1, logical(1L))],
                           center = TRUE, scale = TRUE)

ggbiplot(pca_trigram_res, choices = 1:2, groups = datasets_exp, var.axes = FALSE) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual("Data set", values = colors_short) +
  theme(legend.position = "none")

pca_trigram_res[["x"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp) %>%
  ggplot(aes(x = PC1, y = PC2, color = dataset)) +
  geom_point(alpha = 0.5) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()

pca_trigram_res[["x"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp,
         name = unlist(sapply(names(datasets_list_exp), function(i) names(datasets_list_exp[[i]]), USE.NAMES = FALSE))) %>%
  plot_ly(x = ~PC1, y = ~PC2, color = ~dataset, colors = colors_short, text = ~name, hoverinfo = "text")

pca_trigram_res[["x"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp) %>%
  ggplot(aes(x = PC1, y = PC2, color = dataset)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~dataset) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw() +
  theme(legend.position = "none")
```

### t-SNE

Perplexity = 30
```{r}
tsne_trigrams_res <- tsne(trigrams_exp, k = 2, perplexity = 30, max_iter = 1000)
mutate(as.data.frame(tsne_trigrams_res1), dataset = datasets_exp) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point(size = 2) +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

### UMAP

Neighbors = 30, spread = 1, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 1
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 30

umap_res <- umap(trigrams_exp, config = umap_config)
umap_res[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```

Neighbors = 50, spread = 1, min_dist = 0.5
```{r}
umap_config <- umap.defaults
umap_config[["random_state"]] <- 73607254
umap_config[["spread"]] <- 1
umap_config[["min_dist"]] <- 0.5
umap_config[["n_neighbors"]] <- 50

umap_res1 <- umap(trigrams_exp, config = umap_config)
umap_res1[["layout"]] %>%
  as.data.frame() %>%
  mutate(dataset = datasets_exp) %>%
  ggplot(aes(x = V1, y = V2, color = dataset)) +
  geom_point() +
  scale_color_manual("Data set", values = colors_short) +
  theme_bw()
```
